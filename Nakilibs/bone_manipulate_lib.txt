--@name nakilibs/bone_manipulate_lib
--@author Nakkitsunami
--@client
-- Derived from BoneMatcher by Sparky and help from Starfall discord, thanks


--[[

CURRENTLY BROKEN, FIXING PARENT RELATIVE ANGLES

--]]


bone_manipulate_lib = {}

function bone_manipulate_lib.validateBones(ent,lookup_table,write_ids,write_parents)
    local temp1 = {}
    local temp2 = {}
    for i, bone_name in pairs(lookup_table) do
        local bone_id = ent:lookupBone(bone_name)
        if bone_id == nil then
            return false, {}, {}
        end
        local parent_id = ent:getBoneParent(bone_id)
        temp1[bone_name] = bone_id
        temp2[bone_name] = parent_id
    end
    write_ids = table.copy(temp1)
    write_parents = table.copy(temp2)
    return true, write_ids, write_parents
end

function bone_manipulate_lib.storeBoneAngles(ent,lookup_table)
    local ret = {}
    for i, boneid in pairs(lookup_table) do
        if ent:getBoneName(boneid) != "" then
            _, ret[tostring(boneid)] = ent:getBonePosition(boneid)
            local parent_id = ent:getBoneParent(boneid)
            if parent_id != -1 and parent_id != boneid then
                _, ret[tostring(parent_id)] = ent:getBonePosition(parent_id)
            end
        end
    end
    if table.count(ret) == 0 then
        return false
    else
        ent.ref_t = ret
        return true
    end
end

function bone_manipulate_lib.setBoneAngles(ent,bone_id,parent_id,ang)
    if ent._STATE_SET_BONE_ANGLES_BLOCK then return end
    local ref = ent.ref_t
    if not ref then
        ent._STATE_SET_BONE_ANGLES_BLOCK = true
        print("Reference table not created yet! Preventing setBoneAngles from running further on this model to prevent chip from crashing!")
        return
    end
    local original = ref[tostring(bone_id)]
    local _, parent_angle = ent:getBonePosition(parent_id)
    local parent_original = ref[tostring(parent_id)]
    
    local _, ang_world = worldToLocal(Vector(),ang,Vector(),original+(parent_angle-parent_original))
    
    ent:manipulateBoneAngles(bone_id, ang_world)
end
