--@name NVG Projected Texture Version
--@author Nakkitsunami
--@client
--@owneronly

enableHud(owner(), true)

local button = KEY.N
local slanted_view = true
local button_down = false

local down = false

local w, h = render.getGameResolution()

local rtName = "fullbright"
render.createRenderTarget(rtName)
local tex = material.create("gmodscreenspace")
tex:setTextureRenderTarget("$basetexture", rtName)

local circle = render.createMaterial("gmod/scope", nil, nil)
local circle2 = material.load("sprites/light_ignorez")

local ProjectedTexture = light.createProjected()
ProjectedTexture:setTexture("effects/flashlight/soft")

function toggle_light(bool)
    ProjectedTexture:setHorizontalFOV(bool and 3*25 or 0)
    ProjectedTexture:setVerticalFOV(bool and 4*25 or 0)
    ProjectedTexture:setBrightness(bool and 4 or 0)
    ProjectedTexture:setFarZ(bool and 4000 or 0)
end
toggle_light(false)

ProjectedTexture:setEnableShadows(false)
hook.add("RenderScene", "", function(origin, angles, fov)
    if (owner() and owner() != nil and owner():isValid() and owner():getHealth() > 0) then
        render.selectRenderTarget(rtName)
        
        render.renderView({
            origin = owner():getEyePos(),
            angles = owner():getEyeAngles(),
            aspectratio = slanted_view and 1 or w/h,
            x = 0,
            y = 0,
            w = w,
            h = h,
            drawviewmodel = true,
            drawviewer = false,
        })
    end
    render.selectRenderTarget()
end)

hook.add("CalcView", "", function(pos, ang, fov, znear, zfar)
    ProjectedTexture:setPos(pos)
    ProjectedTexture:setAngles(ang)
    ProjectedTexture:update()
end)

local change_ct = 0
hook.add("DrawHUD", "", function()
    if (owner() and owner() != nil and owner():isValid() and owner():getHealth() > 0) then
        
        local delta = math.clamp(timer.curtime() - change_ct,0,1)
        local can_change = delta >= 1
        
        if input.isKeyDown(button) and not owner():isTyping() then
            if button_down != true then
                button_down = true
                if can_change then
                    down = not down
                    change_ct = down and timer.curtime() or timer.curtime()
                    delta = 0
                    toggle_light(down)
                    if down then
                        owner():emitSound("physics/metal/weapon_footstep2.wav", 100, 125, 1, CHANNEL_AUTO)
                    else
                        owner():emitSound("physics/metal/weapon_footstep1.wav", 100, 125, 1, CHANNEL_AUTO)
                    end
                end
            end
        else
            if button_down != false then
                button_down = false
            end
        end
        
        local fade = math.clamp((-0.25+delta*5),0,1)
        
        if down then
            render.setMaterial(tex)
            render.drawTexturedRect(0,0,w,h)
            
            render.setColor(Color(255*(fade<=0 and 0 or 1 - fade),255*(fade<=0 and 0 or 1),255*(fade<=0 and 0 or 1 - fade),255-225*fade))
            render.drawRectFast(0,0,w,h)
            
            render.setColor(Color(200,225,200,100))
            render.setMaterial(circle2)
            render.drawTexturedRect(w/2-h/2*2, h/2-h/2*2, h*2, h*2)
            
            render.setColor(Color(0,5,0))
            render.drawRectFast(0,0,w/2-h/2,h)
            render.drawRectFast(w/2+h/2,0,w/2-h/2,h)
            render.setMaterial(circle)
            render.drawTexturedRect(w/2-h/2, h/2-h/2, h, h)
        else
            render.setColor(Color(0,0,0,255*math.clamp((1-delta*4)*2,0,1)))
            render.drawRectFast(0,0,w,h)
        end
    else
        down = false
    end
end)
